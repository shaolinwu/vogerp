<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ns2:UIPage xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ns2="http://bmdp.shaolin.org/datamodel/Page" xmlns="http://bmdp.shaolin.org/datamodel/Common"
	xsi:schemaLocation="">
	<entityName>org.shaolin.vogerp.coupon.page.AdvertManagement</entityName>
	<systemVersion>0</systemVersion>
	<description>抽奖系统</description>

	<ns2:UIEntity xsi:type="ns2:UIEntityType">
		<!-- changeAdvertImage -->
		<ns2:eventHandler functionName="changeAdvertImage">
			<ns2:ops xsi:type="ns2:OpCallAjaxType" name="changeAdvertImage-20160112-232035">
				<ns2:exp>
					<expressionString><![CDATA[
					import org.shaolin.vogerp.coupon.be.CouponSystemImpl;
		            import org.shaolin.vogerp.coupon.dao.CouponModel;
		            import java.util.List;
		            import java.util.Date;
		            import org.shaolin.bmdp.runtime.security.UserContext;
		            {
		            	String topAdvertImage = @page.getTextField("topAdvertUI").getValue();
		            	String bottomAdvertImage = @page.getTextField("bottomAdvertUI").getValue();
		            	
		            	CouponSystemImpl condition = new CouponSystemImpl();
		            	condition.setOrgId((Long)UserContext.getUserData(UserContext.CURRENT_USER_ORGID));
		            	List couponSystems = CouponModel.INSTANCE.searchCouponSystem(condition, null, 0, 0);
		            	if (couponSystems == null || couponSystems.size() <=0) {
		            		CouponSystemImpl couponSystem = new CouponSystemImpl();
		            		couponSystem.setOrgId((Long)UserContext.getUserData(UserContext.CURRENT_USER_ORGID));
		            		couponSystem.setIsDevelopTest(false);
		            		couponSystem.setIsValidateOpenId(true);
		            		couponSystem.setIsMaintain(false);
		            		couponSystem.setTopAdvertImage(topAdvertImage);
		            		couponSystem.setBottomAdvertImage(bottomAdvertImage);
		            		couponSystem.setCreateDate(new Date());
		            		CouponModel.INSTANCE.create(couponSystem);
		            	} else {
		            		CouponSystemImpl couponSystem = (CouponSystemImpl) couponSystems.get(0);
		            		couponSystem.setTopAdvertImage(topAdvertImage);
		            		couponSystem.setBottomAdvertImage(bottomAdvertImage);
		            		CouponModel.INSTANCE.update(couponSystem);
		            	}
		            	
		            	@page.executeJavaScript("alert('更换成功')");
					}
					]]></expressionString>
				</ns2:exp>
			</ns2:ops>
		</ns2:eventHandler>
		
		<ns2:eventHandler functionName="selectTopAdvertImage">
		    <ns2:ops xsi:type="ns2:OpCallAjaxType" name="selectTopAdvertImage-1317628417">
		      <ns2:exp>
		        <expressionString><![CDATA[
		        import java.util.HashMap;
		        import org.shaolin.uimaster.page.AjaxContext;
		        import org.shaolin.uimaster.page.ajax.*;
		        import org.shaolin.bmdp.runtime.security.UserContext;
		        { 
		           HashMap input = new HashMap();
		           input.put("editable", new Boolean(true));
		           input.put("callbackUIID", @page.getTextField("topAdvertUI").getId());
		           Long orgId = (Long)UserContext.getUserData(UserContext.CURRENT_USER_ORGID);
		           input.put("imagePath", "/images/coupon/front/couponIcon/" + orgId);
		           RefForm form = new RefForm("selectImageForm", "org.shaolin.vogerp.commonmodel.form.ImageViewer", input);
		           @page.addElement(form);
		           form.openInWindows("Image Viewer", null, 620, 450);
		        }]]></expressionString>
		      </ns2:exp>
		    </ns2:ops>
		  </ns2:eventHandler>
		  <ns2:eventHandler functionName="selectBottomAdvertImage">
		    <ns2:ops xsi:type="ns2:OpCallAjaxType" name="selectBottomAdvertImage-1317628417">
		      <ns2:exp>
		        <expressionString><![CDATA[
		        import java.util.HashMap;
		        import org.shaolin.uimaster.page.AjaxContext;
		        import org.shaolin.uimaster.page.ajax.*;
		        import org.shaolin.bmdp.runtime.security.UserContext;
		        { 
		           HashMap input = new HashMap();
		           input.put("editable", new Boolean(true));
		           input.put("callbackUIID", @page.getTextField("bottomAdvertUI").getId());
		           Long orgId = (Long)UserContext.getUserData(UserContext.CURRENT_USER_ORGID);
		           input.put("imagePath", "/images/coupon/front/couponIcon/" + orgId);
		           RefForm form = new RefForm("selectImageForm", "org.shaolin.vogerp.commonmodel.form.ImageViewer", input);
		           @page.addElement(form);
		           form.openInWindows("Image Viewer", null, 620, 450);
		        }]]></expressionString>
		      </ns2:exp>
		    </ns2:ops>
		  </ns2:eventHandler>
		
		<ns2:body UIID="Form" xsi:type="ns2:UIPanelType">
			<ns2:layout xsi:type="ns2:TableLayoutType">
				<ns2:rowHeightWeight>0.0</ns2:rowHeightWeight>
				<ns2:rowHeightWeight>0.0</ns2:rowHeightWeight>
				<ns2:rowHeightWeight>0.0</ns2:rowHeightWeight>
				<ns2:columnWidthWeight>0.0</ns2:columnWidthWeight>
				<ns2:columnWidthWeight>0.0</ns2:columnWidthWeight>
			</ns2:layout>
		    <ns2:component xsi:type="ns2:UILabelType" UIID="topAdvertLabel">
		        <ns2:UIStyle>uimaster_leftform_widget</ns2:UIStyle>
		        <ns2:text xsi:type="ns2:ResourceBundlePropertyType">
		          <ns2:bundle>org_shaolin_vogerp_coupon_i18n</ns2:bundle>
		          <ns2:key>org.shaolin.vogerp.coupon.be.CouponSystem.topAdvertImage</ns2:key>
		        </ns2:text>
		        <ns2:EventListener xsi:type="ns2:ClickListenerType">
		          <ns2:handler functionName="selectTopAdvertImage"></ns2:handler>
		        </ns2:EventListener>
		      </ns2:component>
		      <ns2:component xsi:type="ns2:UITextFieldType" UIID="topAdvertUI">
		        <ns2:UIStyle>uimaster_rightform_widget</ns2:UIStyle>
		        <ns2:text xsi:type="ns2:ExpressionPropertyType">
		        	<ns2:expression>
			           <expressionString><![CDATA[
			           { 
			           		return $topAdvertImage;
			           }]]></expressionString>
			         </ns2:expression>
		        </ns2:text>
		      </ns2:component>
		      <ns2:component xsi:type="ns2:UILabelType" UIID="bottomAdvertLabel">
		        <ns2:UIStyle>uimaster_leftform_widget</ns2:UIStyle>
		        <ns2:text xsi:type="ns2:ResourceBundlePropertyType">
		          <ns2:bundle>org_shaolin_vogerp_coupon_i18n</ns2:bundle>
		          <ns2:key>org.shaolin.vogerp.coupon.be.CouponSystem.bottomAdvertImage</ns2:key>
		        </ns2:text>
		        <ns2:EventListener xsi:type="ns2:ClickListenerType">
		          <ns2:handler functionName="selectBottomAdvertImage"></ns2:handler>
		        </ns2:EventListener>
		      </ns2:component>
		      <ns2:component xsi:type="ns2:UITextFieldType" UIID="bottomAdvertUI">
		        <ns2:UIStyle>uimaster_rightform_widget</ns2:UIStyle>
		        <ns2:text xsi:type="ns2:ExpressionPropertyType">
		        	<ns2:expression>
			           <expressionString><![CDATA[
			           { 
			           		return $bottomAdvertImage;
			           }]]></expressionString>
			         </ns2:expression>
		        </ns2:text>
		      </ns2:component>
		      <ns2:component xsi:type="ns2:UIButtonType" UIID="changeBtn">
		      		<ns2:UIStyle>uimaster_leftform_widget</ns2:UIStyle>
                   <ns2:text xsi:type="ns2:StringPropertyType">
                       <ns2:value>更换广告图片</ns2:value>
                   </ns2:text>
                   <ns2:EventListener xsi:type="ns2:ClickListenerType">
                       <ns2:handler functionName="changeAdvertImage" />
                   </ns2:EventListener>
               </ns2:component>
               <ns2:layoutConstraint>
                    <ns2:componentId>topAdvertLabel</ns2:componentId>
                    <ns2:constraint xsi:type="ns2:TableLayoutConstraintType"
                        x="0" y="0" align="FULL"></ns2:constraint>
                </ns2:layoutConstraint>
                <ns2:layoutConstraint>
                    <ns2:componentId>topAdvertUI</ns2:componentId>
                    <ns2:constraint xsi:type="ns2:TableLayoutConstraintType"
                        x="1" y="0" align="FULL"></ns2:constraint>
                </ns2:layoutConstraint>
                <ns2:layoutConstraint>
                    <ns2:componentId>bottomAdvertLabel</ns2:componentId>
                    <ns2:constraint xsi:type="ns2:TableLayoutConstraintType"
                        x="0" y="1" align="FULL"></ns2:constraint>
                </ns2:layoutConstraint>
                <ns2:layoutConstraint>
                    <ns2:componentId>bottomAdvertUI</ns2:componentId>
                    <ns2:constraint xsi:type="ns2:TableLayoutConstraintType"
                        x="1" y="1" align="FULL"></ns2:constraint>
                </ns2:layoutConstraint>
                <ns2:layoutConstraint>
                    <ns2:componentId>changeBtn</ns2:componentId>
                    <ns2:constraint xsi:type="ns2:TableLayoutConstraintType"
                        x="0" y="2" align="FULL"></ns2:constraint>
                </ns2:layoutConstraint>
		</ns2:body>
	</ns2:UIEntity>
	<ns2:ODMapping>
		<ns2:DataEntity scope="InOut" name="couponSystem"
			category="BusinessEntity">
			<type entityName="org.shaolin.vogerp.coupon.be.CouponSystem"></type>
		</ns2:DataEntity>
		<ns2:DataEntity scope="InOut" name="topAdvertImage" category="JavaClass">
			<type entityName="java.lang.String"></type>
		</ns2:DataEntity>
		<ns2:DataEntity scope="InOut" name="bottomAdvertImage" category="JavaClass">
			<type entityName="java.lang.String"></type>
		</ns2:DataEntity>
	</ns2:ODMapping>
	<ns2:in>
		<ns2:serverOperation xsi:type="ns2:ExpressionParamType">
            <ns2:expressionString><![CDATA[
            import org.shaolin.vogerp.coupon.be.CouponSystemImpl;
            import org.shaolin.vogerp.coupon.dao.CouponModel;
            import java.util.List;
            import java.util.Date;
            import org.shaolin.bmdp.runtime.security.UserContext;
            {
            	CouponSystemImpl condition = new CouponSystemImpl();
            	condition.setOrgId((Long)UserContext.getUserData(UserContext.CURRENT_USER_ORGID));
            	List couponSystems = CouponModel.INSTANCE.searchCouponSystem(condition, null, 0, 0);
            	if (couponSystems != null || couponSystems.size() > 0) {
            		CouponSystemImpl couponSystem = (CouponSystemImpl) couponSystems.get(0);
            		$topAdvertImage = couponSystem.getTopAdvertImage();
            		$bottomAdvertImage = couponSystem.getBottomAdvertImage();
            	}
			}]]></ns2:expressionString>
        </ns2:serverOperation>
	</ns2:in>
</ns2:UIPage>